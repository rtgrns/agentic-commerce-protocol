<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agentic Checkout - Test Interface</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 40px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 32px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 16px;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        background: #48bb78;
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .section h2 {
        color: #333;
        margin-bottom: 15px;
        font-size: 20px;
      }

      .input-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-weight: 500;
        font-size: 14px;
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
        margin-top: 10px;
        margin-right: 10px;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .response-area {
        margin-top: 20px;
        padding: 20px;
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        max-height: 500px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .response-area:empty::before {
        content: "API responses will appear here...";
        color: #718096;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }

      .status-success {
        background: #48bb78;
        color: white;
      }

      .status-error {
        background: #f56565;
        color: white;
      }

      .info-box {
        background: #edf2f7;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 14px;
        color: #4a5568;
      }

      .info-box strong {
        color: #2d3748;
      }

      .info-box code {
        background: #cbd5e0;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
      }

      .product-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 15px;
        padding: 10px;
        background: white;
        border-radius: 6px;
      }

      .product-item {
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .product-item:hover {
        background: #f7fafc;
        border-color: #667eea;
      }

      .product-item.selected {
        background: #e6f2ff;
        border-color: #667eea;
        border-width: 2px;
      }

      .product-item h4 {
        margin-bottom: 5px;
        color: #333;
      }

      .product-item p {
        font-size: 12px;
        color: #666;
        margin: 3px 0;
      }

      .flow-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 8px;
      }

      .flow-step {
        flex: 1;
        text-align: center;
        position: relative;
      }

      .flow-step::after {
        content: "‚Üí";
        position: absolute;
        right: -10px;
        top: 50%;
        transform: translateY(-50%);
        color: #cbd5e0;
        font-size: 24px;
      }

      .flow-step:last-child::after {
        display: none;
      }

      .flow-step.active .step-number {
        background: #667eea;
        color: white;
      }

      .flow-step.completed .step-number {
        background: #48bb78;
        color: white;
      }

      .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e2e8f0;
        color: #718096;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin: 0 auto 10px;
      }

      .step-label {
        font-size: 12px;
        color: #4a5568;
      }

      .session-info {
        background: #e6fffa;
        border: 2px solid #81e6d9;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
      }

      .session-info p {
        margin: 5px 0;
        font-size: 14px;
      }

      .session-info strong {
        color: #234e52;
      }

      .session-info code {
        background: #ffffff;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
        color: #2c7a7b;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üõí Agentic Commerce Protocol</h1>
      <p class="subtitle">
        OpenAI Spec Compliant Test Interface
        <span class="badge">PRODUCTION READY</span>
      </p>

      <!-- Flow Indicator -->
      <div class="flow-indicator">
        <div class="flow-step" id="step1">
          <div class="step-number">1</div>
          <div class="step-label">Products</div>
        </div>
        <div class="flow-step" id="step2">
          <div class="step-number">2</div>
          <div class="step-label">Create Session</div>
        </div>
        <div class="flow-step" id="step3">
          <div class="step-number">3</div>
          <div class="step-label">Add Address</div>
        </div>
        <div class="flow-step" id="step4">
          <div class="step-number">4</div>
          <div class="step-label">Select Shipping</div>
        </div>
        <div class="flow-step" id="step5">
          <div class="step-number">5</div>
          <div class="step-label">Complete</div>
        </div>
      </div>

      <!-- Session Info -->
      <div id="sessionInfo" class="session-info" style="display: none">
        <p><strong>Session ID:</strong> <code id="currentSessionId">-</code></p>
        <p><strong>Status:</strong> <code id="currentStatus">-</code></p>
        <p><strong>Total:</strong> <code id="currentTotal">-</code></p>
      </div>

      <!-- Section 1: View Products -->
      <div class="section">
        <h2>üì¶ Step 1: Browse Products</h2>
        <div class="info-box">
          <strong>Endpoint:</strong> <code>GET /api/products/feed</code><br />
          <strong>Description:</strong> Fetches OpenAI-compliant product catalog
        </div>
        <button onclick="getProducts()">üîÑ Load Products</button>
        <div id="productList" class="product-list" style="display: none"></div>
      </div>

      <!-- Section 2: Create Checkout Session -->
      <div class="section">
        <h2>üõçÔ∏è Step 2: Create Checkout Session</h2>
        <div class="info-box">
          <strong>Endpoint:</strong> <code>POST /checkout_sessions</code><br />
          <strong>API-Version:</strong> <code>2025-09-12</code><br />
          <strong>Description:</strong> Creates a new Agentic Checkout session
        </div>
        <div class="input-group">
          <label for="productId">Product SKU:</label>
          <input
            type="text"
            id="productId"
            placeholder="Select a product above or enter SKU"
          />
        </div>
        <div class="input-group">
          <label for="quantity">Quantity:</label>
          <input type="number" id="quantity" value="1" min="1" />
        </div>
        <button onclick="createSession()" id="createBtn">
          ‚ñ∂Ô∏è Create Session
        </button>
      </div>

      <!-- Section 3: Add Shipping Address -->
      <div class="section">
        <h2>üìç Step 3: Add Shipping Address</h2>
        <div class="info-box">
          <strong>Endpoint:</strong>
          <code>POST /checkout_sessions/:id</code><br />
          <strong>Description:</strong> Update session with shipping address
        </div>
        <div class="input-group">
          <label for="name">Full Name:</label>
          <input type="text" id="name" value="John Doe" />
        </div>
        <div class="input-group">
          <label for="address">Address Line 1:</label>
          <input type="text" id="address" value="123 Main Street" />
        </div>
        <div class="input-group">
          <label for="city">City:</label>
          <input type="text" id="city" value="New York" />
        </div>
        <div class="input-group">
          <label for="state">State:</label>
          <input type="text" id="state" value="NY" />
        </div>
        <div class="input-group">
          <label for="postalCode">Postal Code:</label>
          <input type="text" id="postalCode" value="10001" />
        </div>
        <button onclick="addAddress()" id="addressBtn" disabled>
          üìç Add Address
        </button>
      </div>

      <!-- Section 4: Select Shipping -->
      <div class="section">
        <h2>üöö Step 4: Select Shipping Method</h2>
        <div class="info-box">
          <strong>Endpoint:</strong>
          <code>POST /checkout_sessions/:id</code><br />
          <strong>Description:</strong> Select shipping option
        </div>
        <div class="input-group">
          <label for="shippingOption">Shipping Method:</label>
          <select id="shippingOption">
            <option value="">-- Select Shipping --</option>
            <option value="shipping_standard">
              Standard Shipping (5-7 days) - $5.99
            </option>
            <option value="shipping_express">
              Express Shipping (2-3 days) - $19.99
            </option>
          </select>
        </div>
        <button onclick="selectShipping()" id="shippingBtn" disabled>
          üöö Select Shipping
        </button>
      </div>

      <!-- Section 5: Complete Checkout -->
      <div class="section">
        <h2>üí≥ Step 5: Complete Checkout</h2>
        <div class="info-box">
          <strong>Endpoint:</strong>
          <code>POST /checkout_sessions/:id/complete</code><br />
          <strong>Description:</strong> Complete checkout with payment
        </div>
        <div class="input-group">
          <label for="paymentToken">Payment Token:</label>
          <select id="paymentToken">
            <option value="tok_visa">tok_visa (Test Visa)</option>
            <option value="tok_mastercard">
              tok_mastercard (Test Mastercard)
            </option>
            <option value="tok_amex">tok_amex (Test Amex)</option>
          </select>
        </div>
        <button onclick="completeCheckout()" id="completeBtn" disabled>
          üí∞ Complete & Pay
        </button>
      </div>

      <!-- Section 6: View Session -->
      <div class="section">
        <h2>üîç View Session & Order</h2>
        <div class="info-box">
          <strong>Endpoints:</strong>
          <code>GET /checkout_sessions/:id</code><br />
          <strong>Description:</strong> View current session state and order
          details
        </div>
        <button onclick="getSession()" id="getSessionBtn" disabled>
          üîç Get Session
        </button>
        <button onclick="cancelSession()" id="cancelBtn" disabled>
          ‚ùå Cancel Session
        </button>
      </div>

      <!-- Response Area -->
      <div class="section">
        <h2>üìÑ API Response</h2>
        <div id="response" class="response-area"></div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:3000";
      const API_VERSION = "2025-09-12";

      let currentSessionId = "";
      let currentOrderId = "";
      let currentStatus = "";
      let loadedProducts = [];

      // Helper to make API calls with proper headers
      async function apiCall(endpoint, options = {}) {
        const headers = {
          "Content-Type": "application/json",
          "API-Version": API_VERSION,
          Authorization: "Bearer test_key_123",
          "Idempotency-Key": `idem_${Date.now()}_${Math.random()}`,
          ...options.headers,
        };

        return fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers,
        });
      }

      // Flow management
      function updateFlow(step) {
        for (let i = 1; i <= 5; i++) {
          const stepEl = document.getElementById(`step${i}`);
          if (stepEl) {
            stepEl.classList.remove("active", "completed");
            if (i < step) stepEl.classList.add("completed");
            if (i === step) stepEl.classList.add("active");
          }
        }
      }

      // Update session info display
      function updateSessionInfo() {
        const sessionInfo = document.getElementById("sessionInfo");
        if (currentSessionId) {
          sessionInfo.style.display = "block";
          document.getElementById("currentSessionId").textContent =
            currentSessionId;
          document.getElementById("currentStatus").textContent =
            currentStatus || "-";
        } else {
          sessionInfo.style.display = "none";
        }
      }

      // Enable/disable buttons based on state
      function updateButtons() {
        document.getElementById("addressBtn").disabled = !currentSessionId;
        document.getElementById("shippingBtn").disabled =
          currentStatus !== "not_ready_for_payment";
        document.getElementById("completeBtn").disabled =
          currentStatus !== "ready_for_payment";
        document.getElementById("getSessionBtn").disabled = !currentSessionId;
        document.getElementById("cancelBtn").disabled =
          !currentSessionId ||
          currentStatus === "completed" ||
          currentStatus === "canceled";
      }

      // Function to display response
      function showResponse(data, isError = false) {
        const responseDiv = document.getElementById("response");
        const formatted = JSON.stringify(data, null, 2);
        responseDiv.textContent = formatted;

        // Add status badge
        const statusBadge = document.createElement("span");
        statusBadge.className = isError
          ? "status-badge status-error"
          : "status-badge status-success";
        statusBadge.textContent = isError ? "ERROR" : "SUCCESS";
        responseDiv.prepend(statusBadge);
        responseDiv.prepend(document.createTextNode("\n\n"));
      }

      // Loading state
      function showLoading(buttonElement) {
        const loading = document.createElement("span");
        loading.className = "loading";
        buttonElement.appendChild(loading);
        buttonElement.disabled = true;
      }

      function hideLoading(buttonElement) {
        const loading = buttonElement.querySelector(".loading");
        if (loading) loading.remove();
        buttonElement.disabled = false;
      }

      // Step 1: Get products
      async function getProducts() {
        const button = event.target;
        showLoading(button);
        updateFlow(1);

        try {
          const response = await fetch(`${API_BASE}/api/products/feed`);
          const data = await response.json();

          if (response.ok) {
            showResponse(data);
            loadedProducts = data.products || [];
            displayProducts(loadedProducts);
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        } finally {
          hideLoading(button);
        }
      }

      // Display products
      function displayProducts(products) {
        const productList = document.getElementById("productList");
        productList.innerHTML = "";
        productList.style.display = "block";

        products.slice(0, 10).forEach((product) => {
          const item = document.createElement("div");
          item.className = "product-item";
          item.onclick = () => selectProduct(product.id, item);

          const price = product.price?.value || 0;
          const currency = product.price?.currency || "USD";

          item.innerHTML = `
            <h4>${product.title || "Untitled"}</h4>
            <p><strong>SKU:</strong> ${product.id}</p>
            <p><strong>Price:</strong> $${price} ${currency}</p>
            <p><strong>Availability:</strong> ${product.availability || "unknown"}</p>
          `;

          productList.appendChild(item);
        });
      }

      // Select product
      function selectProduct(productId, element) {
        document
          .querySelectorAll(".product-item")
          .forEach((el) => el.classList.remove("selected"));
        element.classList.add("selected");

        document.getElementById("productId").value = productId;
        updateFlow(2);
      }

      // Step 2: Create checkout session
      async function createSession() {
        const button = event.target;
        showLoading(button);
        updateFlow(2);

        const productId = document.getElementById("productId").value;
        const quantity = parseInt(document.getElementById("quantity").value);

        if (!productId) {
          showResponse({ error: "Please select a product" }, true);
          hideLoading(button);
          return;
        }

        const requestBody = {
          buyer: {
            first_name: "John",
            last_name: "Doe",
            email: "john.doe@example.com",
            phone_number: "+1234567890",
          },
          items: [
            {
              id: productId,
              quantity: quantity,
            },
          ],
        };

        try {
          const response = await apiCall("/checkout_sessions", {
            method: "POST",
            body: JSON.stringify(requestBody),
          });

          const data = await response.json();

          if (response.ok) {
            currentSessionId = data.id;
            currentStatus = data.status;
            showResponse(data);
            updateSessionInfo();
            updateButtons();
            updateFlow(3);
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        } finally {
          hideLoading(button);
        }
      }

      // Step 3: Add shipping address
      async function addAddress() {
        const button = event.target;
        showLoading(button);
        updateFlow(3);

        const requestBody = {
          fulfillment_address: {
            name: document.getElementById("name").value,
            line_one: document.getElementById("address").value,
            line_two: "",
            city: document.getElementById("city").value,
            state: document.getElementById("state").value,
            country: "US",
            postal_code: document.getElementById("postalCode").value,
          },
        };

        try {
          const response = await apiCall(
            `/checkout_sessions/${currentSessionId}`,
            {
              method: "POST",
              body: JSON.stringify(requestBody),
            }
          );

          const data = await response.json();

          if (response.ok) {
            currentStatus = data.status;
            showResponse(data);
            updateSessionInfo();
            updateButtons();
            updateFlow(4);
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        } finally {
          hideLoading(button);
        }
      }

      // Step 4: Select shipping
      async function selectShipping() {
        const button = event.target;
        showLoading(button);
        updateFlow(4);

        const shippingOption = document.getElementById("shippingOption").value;

        if (!shippingOption) {
          showResponse({ error: "Please select a shipping method" }, true);
          hideLoading(button);
          return;
        }

        const requestBody = {
          fulfillment_option_id: shippingOption,
        };

        try {
          const response = await apiCall(
            `/checkout_sessions/${currentSessionId}`,
            {
              method: "POST",
              body: JSON.stringify(requestBody),
            }
          );

          const data = await response.json();

          if (response.ok) {
            currentStatus = data.status;

            // Extract total
            const totalObj = data.totals?.find((t) => t.type === "total");
            if (totalObj) {
              const totalDollars = (totalObj.amount / 100).toFixed(2);
              document.getElementById("currentTotal").textContent =
                `$${totalDollars} USD`;
            }

            showResponse(data);
            updateSessionInfo();
            updateButtons();
            updateFlow(5);
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        } finally {
          hideLoading(button);
        }
      }

      // Step 5: Complete checkout
      async function completeCheckout() {
        const button = event.target;
        showLoading(button);
        updateFlow(5);

        const paymentToken = document.getElementById("paymentToken").value;

        const requestBody = {
          payment_data: {
            token: paymentToken,
            provider: "stripe",
          },
        };

        try {
          const response = await apiCall(
            `/checkout_sessions/${currentSessionId}/complete`,
            {
              method: "POST",
              body: JSON.stringify(requestBody),
            }
          );

          const data = await response.json();

          if (response.ok) {
            currentStatus = data.status;
            currentOrderId = data.order?.id || "";
            showResponse(data);
            updateSessionInfo();
            updateButtons();

            // Show success message
            if (data.order) {
              setTimeout(() => {
                alert(
                  `‚úÖ Order Complete!\n\nOrder ID: ${data.order.id}\nPermalink: ${data.order.permalink_url}`
                );
              }, 500);
            }
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        } finally {
          hideLoading(button);
        }
      }

      // Get session status
      async function getSession() {
        const button = event.target;
        showLoading(button);

        try {
          const response = await apiCall(
            `/checkout_sessions/${currentSessionId}`,
            {
              method: "GET",
            }
          );

          const data = await response.json();

          if (response.ok) {
            currentStatus = data.status;
            showResponse(data);
            updateSessionInfo();
            updateButtons();
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        } finally {
          hideLoading(button);
        }
      }

      // Cancel session
      async function cancelSession() {
        const button = event.target;
        showLoading(button);

        if (!confirm("Are you sure you want to cancel this session?")) {
          hideLoading(button);
          return;
        }

        try {
          const response = await apiCall(
            `/checkout_sessions/${currentSessionId}/cancel`,
            {
              method: "POST",
              body: JSON.stringify({}),
            }
          );

          const data = await response.json();

          if (response.ok) {
            currentStatus = data.status;
            showResponse(data);
            updateSessionInfo();
            updateButtons();
            alert("Session canceled");
          } else {
            showResponse(data, true);
          }
        } catch (error) {
          showResponse({ error: error.message }, true);
        } finally {
          hideLoading(button);
        }
      }

      // Reset function
      function resetFlow() {
        currentSessionId = "";
        currentOrderId = "";
        currentStatus = "";
        document.getElementById("productId").value = "";
        document.getElementById("quantity").value = "1";
        document.getElementById("shippingOption").value = "";
        updateSessionInfo();
        updateButtons();
        updateFlow(1);
      }

      // Initialize
      updateFlow(1);
      updateButtons();
    </script>
  </body>
</html>
